import pandas as pd
import re
import os

def get_missing_hospital_location(hospital_name):
    """
    专门处理缺失的医院地理位置信息
    """
    # 特殊医院名称映射
    special_hospitals = {
        '陆军军医大学第一附属医院': ('重庆', '重庆'),
        '陆军军医大学第二附属医院': ('重庆', '重庆'),
        '陆军军医大学第三附属医院': ('重庆', '重庆'),
        '中国人民解放军陆军特色医学中心': ('重庆', '重庆'),
        '中国人民解放军联勤保障部队第920医院': ('云南', '昆明'),
        '中国人民解放军联勤保障部队第940医院': ('甘肃', '兰州'),
        '中国人民解放军联勤保障部队第990医院': ('河南', '郑州'),
        '中国人民解放军联勤保障部队第910医院': ('福建', '泉州'),
        '中国人民解放军联勤保障部队第924医院': ('广西', '桂林'),
        '中国人民解放军联勤保障部队第474医院': ('新疆', '乌鲁木齐'),
        '中国人民解放军第474医院': ('新疆', '乌鲁木齐'),
        '中国人民解放军南部战区总医院': ('广东', '广州'),
        '中国人民解放军中部战区总医院': ('湖北', '武汉'),
        '中国人民解放军西部战区总医院': ('四川', '成都'),
        '中国人民解放军新疆军区总医院': ('新疆', '乌鲁木齐'),
        '中国人民解放军总医院海南医院': ('海南', '三亚'),
        '川北医学院附属医院': ('四川', '南充'),
        '西南医科大学附属医院': ('四川', '泸州'),
        '西南医科大学口腔医学院·附属口腔医院': ('四川', '泸州'),
        '西南医科大学中西医结合学院·附属中医医院': ('四川', '泸州'),
        '云南大学附属医院': ('云南', '昆明'),
        '云南省第一人民医院': ('云南', '昆明'),
        '云南省第二人民医院': ('云南', '昆明'),
        '云南省第三人民医院': ('云南', '昆明'),
        '云南省传染病医院': ('云南', '昆明'),
        '云南省精神病医院': ('云南', '昆明'),
        '云南省胸科医院': ('云南', '昆明'),
        '云南省肿瘤医院': ('云南', '昆明'),
        '云南省中医医院': ('云南', '昆明'),
        '云南省妇幼保健院': ('云南', '昆明'),
        '云南省儿童医院': ('云南', '昆明'),
        '云南省皮肤病医院': ('云南', '昆明'),
        '云南省口腔医院': ('云南', '昆明'),
        '云南省康复医院': ('云南', '昆明'),
        '云南省结核病医院': ('云南', '昆明'),
        '云南省心血管病医院': ('云南', '昆明'),
        '云南省神经病医院': ('云南', '昆明'),
        '云南省骨科医院': ('云南', '昆明'),
        '云南省烧伤医院': ('云南', '昆明'),
        '云南省整形医院': ('云南', '昆明'),
        '云南省眼科医院': ('云南', '昆明'),
        '云南省耳鼻喉医院': ('云南', '昆明'),
        '云南省皮肤性病医院': ('云南', '昆明'),
        '云南省职业病医院': ('云南', '昆明'),
        '云南省艾滋病关爱中心': ('云南', '昆明'),
        '云南省心理卫生中心': ('云南', '昆明'),
        '贵州省人民医院': ('贵州', '贵阳'),
        '贵州省第二人民医院': ('贵州', '贵阳'),
        '贵州省肿瘤医院': ('贵州', '贵阳'),
        '贵州省妇幼保健院': ('贵州', '贵阳'),
        '贵州省儿童医院': ('贵州', '贵阳'),
        '贵州省胸科医院': ('贵州', '贵阳'),
        '贵州省结核病医院': ('贵州', '贵阳'),
        '贵州省心血管病医院': ('贵州', '贵阳'),
        '贵州省神经病医院': ('贵州', '贵阳'),
        '贵州省骨科医院': ('贵州', '贵阳'),
        '贵州省烧伤医院': ('贵州', '贵阳'),
        '贵州省整形医院': ('贵州', '贵阳'),
        '贵州省眼科医院': ('贵州', '贵阳'),
        '贵州省耳鼻喉医院': ('贵州', '贵阳'),
        '贵州省皮肤性病医院': ('贵州', '贵阳'),
        '贵州省职业病医院': ('贵州', '贵阳'),
        '贵州省传染病医院': ('贵州', '贵阳'),
        '贵州省艾滋病关爱中心': ('贵州', '贵阳'),
        '贵州省心理卫生中心': ('贵州', '贵阳'),
        '四川省人民医院': ('四川', '成都'),
        '四川省肿瘤医院': ('四川', '成都'),
        '四川省妇幼保健院': ('四川', '成都'),
        '四川省儿童医院': ('四川', '成都'),
        '四川省胸科医院': ('四川', '成都'),
        '四川省结核病医院': ('四川', '成都'),
        '四川省心血管病医院': ('四川', '成都'),
        '四川省神经病医院': ('四川', '成都'),
        '四川省骨科医院': ('四川', '成都'),
        '四川省烧伤医院': ('四川', '成都'),
        '四川省整形医院': ('四川', '成都'),
        '四川省眼科医院': ('四川', '成都'),
        '四川省耳鼻喉医院': ('四川', '成都'),
        '四川省皮肤性病医院': ('四川', '成都'),
        '四川省职业病医院': ('四川', '成都'),
        '四川省传染病医院': ('四川', '成都'),
        '四川省艾滋病关爱中心': ('四川', '成都'),
        '四川省心理卫生中心': ('四川', '成都'),
        '西藏自治区人民医院': ('西藏', '拉萨'),
        '西藏自治区第二人民医院': ('西藏', '拉萨'),
        '西藏自治区第三人民医院': ('西藏', '拉萨'),
        '西藏自治区妇幼保健院': ('西藏', '拉萨'),
        '西藏自治区儿童医院': ('西藏', '拉萨'),
        '西藏自治区胸科医院': ('西藏', '拉萨'),
        '西藏自治区结核病医院': ('西藏', '拉萨'),
        '西藏自治区心血管病医院': ('西藏', '拉萨'),
        '西藏自治区神经病医院': ('西藏', '拉萨'),
        '西藏自治区骨科医院': ('西藏', '拉萨'),
        '西藏自治区烧伤医院': ('西藏', '拉萨'),
        '西藏自治区整形医院': ('西藏', '拉萨'),
        '西藏自治区眼科医院': ('西藏', '拉萨'),
        '西藏自治区耳鼻喉医院': ('西藏', '拉萨'),
        '西藏自治区皮肤性病医院': ('西藏', '拉萨'),
        '西藏自治区职业病医院': ('西藏', '拉萨'),
        '西藏自治区传染病医院': ('西藏', '拉萨'),
        '西藏自治区艾滋病关爱中心': ('西藏', '拉萨'),
        '西藏自治区心理卫生中心': ('西藏', '拉萨'),
        '重庆市人民医院': ('重庆', '重庆'),
        '重庆市第一人民医院': ('重庆', '重庆'),
        '重庆市第二人民医院': ('重庆', '重庆'),
        '重庆市第三人民医院': ('重庆', '重庆'),
        '重庆市第四人民医院': ('重庆', '重庆'),
        '重庆市第五人民医院': ('重庆', '重庆'),
        '重庆市第六人民医院': ('重庆', '重庆'),
        '重庆市第七人民医院': ('重庆', '重庆'),
        '重庆市第八人民医院': ('重庆', '重庆'),
        '重庆市第九人民医院': ('重庆', '重庆'),
        '重庆市第十人民医院': ('重庆', '重庆'),
        '重庆市妇幼保健院': ('重庆', '重庆'),
        '重庆市儿童医院': ('重庆', '重庆'),
        '重庆市胸科医院': ('重庆', '重庆'),
        '重庆市结核病医院': ('重庆', '重庆'),
        '重庆市心血管病医院': ('重庆', '重庆'),
        '重庆市神经病医院': ('重庆', '重庆'),
        '重庆市骨科医院': ('重庆', '重庆'),
        '重庆市烧伤医院': ('重庆', '重庆'),
        '重庆市整形医院': ('重庆', '重庆'),
        '重庆市眼科医院': ('重庆', '重庆'),
        '重庆市耳鼻喉医院': ('重庆', '重庆'),
        '重庆市皮肤性病医院': ('重庆', '重庆'),
        '重庆市职业病医院': ('重庆', '重庆'),
        '重庆市传染病医院': ('重庆', '重庆'),
        '重庆市艾滋病关爱中心': ('重庆', '重庆'),
        '重庆市心理卫生中心': ('重庆', '重庆'),
        '四川大学华西医院': ('四川', '成都'),
        '四川大学华西第二医院': ('四川', '成都'),
        '四川大学华西口腔医院': ('四川', '成都'),
        '贵州医科大学附属医院': ('贵州', '贵阳'),
        '贵州医科大学第三附属医院': ('贵州', '遵义'),
        '贵州医科大学附属口腔医院': ('贵州', '贵阳'),
        '昆明医科大学第一附属医院': ('云南', '昆明'),
        '昆明医科大学第二附属医院': ('云南', '昆明'),
        '昆明医科大学第三附属医院': ('云南', '昆明'),
        '昆明医科大学附属口腔医院': ('云南', '昆明'),
        '遵义医科大学附属医院': ('贵州', '遵义'),
        '遵义医科大学附属口腔医院': ('贵州', '遵义'),
        '重庆医科大学附属第一医院': ('重庆', '重庆'),
        '重庆医科大学附属第二医院': ('重庆', '重庆'),
        '重庆医科大学附属第三医院': ('重庆', '重庆'),
        '重庆医科大学附属口腔医院': ('重庆', '重庆'),
        '重庆医科大学附属儿童医院': ('重庆', '重庆'),
        '重庆大学附属肿瘤医院': ('重庆', '重庆'),
    }
    
    # 首先检查特殊医院映射
    if hospital_name in special_hospitals:
        return special_hospitals[hospital_name]
    
    # 省份和城市映射
    province_city_map = {
        '四川': ['成都', '自贡', '攀枝花', '泸州', '德阳', '绵阳', '广元', '遂宁', '内江', '乐山', '南充', '眉山', '宜宾', '广安', '达州', '雅安', '巴中', '资阳', '阿坝', '甘孜', '凉山'],
        '贵州': ['贵阳', '六盘水', '遵义', '安顺', '毕节', '铜仁', '黔西南', '黔东南', '黔南'],
        '云南': ['昆明', '曲靖', '玉溪', '保山', '昭通', '丽江', '普洱', '临沧', '楚雄', '红河', '文山', '西双版纳', '大理', '德宏', '怒江', '迪庆'],
        '西藏': ['拉萨', '日喀则', '昌都', '林芝', '山南', '那曲', '阿里'],
        '重庆': ['重庆']
    }
    
    # 根据医院名称推断省份和城市
    for province, cities in province_city_map.items():
        for city in cities:
            if city in hospital_name:
                return province, city
    
    # 如果没有找到具体城市，尝试根据省份关键词推断
    for province in province_city_map.keys():
        if province in hospital_name:
            # 返回省份和空城市
            return province, ""
    
    return "", ""

def final_supplement_csv_file(filename):
    """
    最终补充CSV文件中缺失的医院地理位置信息
    """
    print(f"正在最终补充文件: {filename}")
    
    # 读取CSV文件
    df = pd.read_csv(filename, encoding='utf-8-sig')
    
    # 统计补充前的信息
    before_province_count = len(df[df['省份'] != ''])
    before_city_count = len(df[df['城市'] != ''])
    
    print(f"补充前 - 有省份信息的记录数: {before_province_count}")
    print(f"补充前 - 有城市信息的记录数: {before_city_count}")
    
    # 为缺失信息的医院补充地理位置
    updated_count = 0
    for index, row in df.iterrows():
        if row['省份'] == '' or row['城市'] == '':
            province, city = get_missing_hospital_location(row['医院名称'])
            
            if row['省份'] == '' and province != '':
                df.at[index, '省份'] = province
                updated_count += 1
            if row['城市'] == '' and city != '':
                df.at[index, '城市'] = city
                updated_count += 1
    
    # 统计补充后的信息
    after_province_count = len(df[df['省份'] != ''])
    after_city_count = len(df[df['城市'] != ''])
    
    print(f"补充后 - 有省份信息的记录数: {after_province_count}")
    print(f"补充后 - 有城市信息的记录数: {after_city_count}")
    print(f"新增省份信息: {after_province_count - before_province_count}")
    print(f"新增城市信息: {after_city_count - before_city_count}")
    print(f"总更新次数: {updated_count}")
    
    # 保存更新后的文件
    df.to_csv(filename, index=False, encoding='utf-8-sig')
    print(f"文件已更新: {filename}\n")
    
    return df

def main():
    """
    主函数：最终补充所有CSV文件的地理位置信息
    """
    # 定义要处理的CSV文件列表
    csv_files = [
        "2023年度东北区专科声誉排行榜_with_info.csv",
        "2023年度华北区专科声誉排行榜_with_info.csv",
        "2023年度华东区专科声誉排行榜_with_info.csv",
        "2023年度华南区专科声誉排行榜_with_info.csv",
        "2023年度华中区专科声誉排行榜_with_info.csv",
        "2023年度西北区专科声誉排行榜_with_info.csv",
        "2023年度西南区专科声誉排行榜_with_info.csv"
    ]
    
    print("开始最终补充医院地理位置信息...")
    
    for csv_file in csv_files:
        if os.path.exists(csv_file):
            try:
                df = final_supplement_csv_file(csv_file)
            except Exception as e:
                print(f"处理 {csv_file} 时出错: {str(e)}\n")
        else:
            print(f"文件不存在: {csv_file}\n")
    
    print("所有文件地理位置信息最终补充完成！")

if __name__ == "__main__":
    main() 