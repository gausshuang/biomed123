import pandas as pd
import re
import os

def get_hospital_location_improved(hospital_name):
    """
    改进的医院地理位置推断函数
    """
    # 省份和城市映射
    province_city_map = {
        # 东北区
        '辽宁': ['沈阳', '大连', '鞍山', '抚顺', '本溪', '丹东', '锦州', '营口', '阜新', '辽阳', '盘锦', '铁岭', '朝阳', '葫芦岛'],
        '吉林': ['长春', '吉林市', '四平', '辽源', '通化', '白山', '松原', '白城', '延边'],
        '黑龙江': ['哈尔滨', '齐齐哈尔', '鸡西', '鹤岗', '双鸭山', '大庆', '伊春', '佳木斯', '七台河', '牡丹江', '黑河', '绥化', '大兴安岭'],
        
        # 华北区
        '北京': ['北京'],
        '天津': ['天津'],
        '河北': ['石家庄', '唐山', '秦皇岛', '邯郸', '邢台', '保定', '张家口', '承德', '沧州', '廊坊', '衡水'],
        '山西': ['太原', '大同', '阳泉', '长治', '晋城', '朔州', '晋中', '运城', '忻州', '临汾', '吕梁'],
        '内蒙古': ['呼和浩特', '包头', '乌海', '赤峰', '通辽', '鄂尔多斯', '呼伦贝尔', '巴彦淖尔', '乌兰察布', '兴安盟', '锡林郭勒盟', '阿拉善盟'],
        
        # 华东区
        '上海': ['上海'],
        '江苏': ['南京', '无锡', '徐州', '常州', '苏州', '南通', '连云港', '淮安', '盐城', '扬州', '镇江', '泰州', '宿迁'],
        '浙江': ['杭州', '宁波', '温州', '嘉兴', '湖州', '绍兴', '金华', '衢州', '舟山', '台州', '丽水'],
        '安徽': ['合肥', '芜湖', '蚌埠', '淮南', '马鞍山', '淮北', '铜陵', '安庆', '黄山', '滁州', '阜阳', '宿州', '六安', '亳州', '池州', '宣城'],
        '福建': ['福州', '厦门', '莆田', '三明', '泉州', '漳州', '南平', '龙岩', '宁德'],
        '江西': ['南昌', '景德镇', '萍乡', '九江', '新余', '鹰潭', '赣州', '吉安', '宜春', '抚州', '上饶'],
        '山东': ['济南', '青岛', '淄博', '枣庄', '东营', '烟台', '潍坊', '济宁', '泰安', '威海', '日照', '莱芜', '临沂', '德州', '聊城', '滨州', '菏泽'],
        
        # 华南区
        '广东': ['广州', '韶关', '深圳', '珠海', '汕头', '佛山', '江门', '湛江', '茂名', '肇庆', '惠州', '梅州', '汕尾', '河源', '阳江', '清远', '东莞', '中山', '潮州', '揭阳', '云浮'],
        '广西': ['南宁', '柳州', '桂林', '梧州', '北海', '防城港', '钦州', '贵港', '玉林', '百色', '贺州', '河池', '来宾', '崇左'],
        '海南': ['海口', '三亚', '三沙', '儋州'],
        
        # 华中区
        '河南': ['郑州', '开封', '洛阳', '平顶山', '安阳', '鹤壁', '新乡', '焦作', '濮阳', '许昌', '漯河', '三门峡', '南阳', '商丘', '信阳', '周口', '驻马店', '济源'],
        '湖北': ['武汉', '黄石', '十堰', '宜昌', '襄阳', '鄂州', '荆门', '孝感', '荆州', '黄冈', '咸宁', '随州', '恩施'],
        '湖南': ['长沙', '株洲', '湘潭', '衡阳', '邵阳', '岳阳', '常德', '张家界', '益阳', '郴州', '永州', '怀化', '娄底', '湘西'],
        
        # 西北区
        '陕西': ['西安', '铜川', '宝鸡', '咸阳', '渭南', '延安', '汉中', '榆林', '安康', '商洛'],
        '甘肃': ['兰州', '嘉峪关', '金昌', '白银', '天水', '武威', '张掖', '平凉', '酒泉', '庆阳', '定西', '陇南', '临夏', '甘南'],
        '青海': ['西宁', '海东', '海北', '黄南', '海南', '果洛', '玉树', '海西'],
        '宁夏': ['银川', '石嘴山', '吴忠', '固原', '中卫'],
        '新疆': ['乌鲁木齐', '克拉玛依', '吐鲁番', '哈密', '昌吉', '博尔塔拉', '巴音郭楞', '阿克苏', '克孜勒苏', '喀什', '和田', '伊犁', '塔城', '阿勒泰'],
        
        # 西南区
        '四川': ['成都', '自贡', '攀枝花', '泸州', '德阳', '绵阳', '广元', '遂宁', '内江', '乐山', '南充', '眉山', '宜宾', '广安', '达州', '雅安', '巴中', '资阳', '阿坝', '甘孜', '凉山'],
        '贵州': ['贵阳', '六盘水', '遵义', '安顺', '毕节', '铜仁', '黔西南', '黔东南', '黔南'],
        '云南': ['昆明', '曲靖', '玉溪', '保山', '昭通', '丽江', '普洱', '临沧', '楚雄', '红河', '文山', '西双版纳', '大理', '德宏', '怒江', '迪庆'],
        '西藏': ['拉萨', '日喀则', '昌都', '林芝', '山南', '那曲', '阿里'],
        '重庆': ['重庆']
    }
    
    # 特殊医院名称映射
    special_hospitals = {
        '陆军军医大学第一附属医院': ('重庆', '重庆'),
        '陆军军医大学第二附属医院': ('重庆', '重庆'),
        '陆军军医大学第三附属医院': ('重庆', '重庆'),
        '中国人民解放军陆军特色医学中心': ('重庆', '重庆'),
        '中国人民解放军联勤保障部队第920医院': ('云南', '昆明'),
        '中国人民解放军联勤保障部队第940医院': ('甘肃', '兰州'),
        '中国人民解放军联勤保障部队第990医院': ('河南', '郑州'),
        '中国人民解放军联勤保障部队第910医院': ('福建', '泉州'),
        '中国人民解放军联勤保障部队第924医院': ('广西', '桂林'),
        '中国人民解放军联勤保障部队第474医院': ('新疆', '乌鲁木齐'),
        '中国人民解放军第474医院': ('新疆', '乌鲁木齐'),
        '中国人民解放军南部战区总医院': ('广东', '广州'),
        '中国人民解放军中部战区总医院': ('湖北', '武汉'),
        '中国人民解放军西部战区总医院': ('四川', '成都'),
        '中国人民解放军新疆军区总医院': ('新疆', '乌鲁木齐'),
        '中国人民解放军总医院海南医院': ('海南', '三亚'),
        '川北医学院附属医院': ('四川', '南充'),
        '西南医科大学附属医院': ('四川', '泸州'),
        '西南医科大学口腔医学院·附属口腔医院': ('四川', '泸州'),
        '西南医科大学中西医结合学院·附属中医医院': ('四川', '泸州'),
        '云南大学附属医院': ('云南', '昆明'),
        '云南省第一人民医院': ('云南', '昆明'),
        '云南省第二人民医院': ('云南', '昆明'),
        '云南省第三人民医院': ('云南', '昆明'),
        '云南省传染病医院': ('云南', '昆明'),
        '云南省精神病医院': ('云南', '昆明'),
        '云南省胸科医院': ('云南', '昆明'),
        '云南省肿瘤医院': ('云南', '昆明'),
        '云南省中医医院': ('云南', '昆明'),
        '云南省妇幼保健院': ('云南', '昆明'),
        '云南省儿童医院': ('云南', '昆明'),
        '云南省皮肤病医院': ('云南', '昆明'),
        '云南省口腔医院': ('云南', '昆明'),
        '云南省康复医院': ('云南', '昆明'),
        '云南省结核病医院': ('云南', '昆明'),
        '云南省心血管病医院': ('云南', '昆明'),
        '云南省神经病医院': ('云南', '昆明'),
        '云南省骨科医院': ('云南', '昆明'),
        '云南省烧伤医院': ('云南', '昆明'),
        '云南省整形医院': ('云南', '昆明'),
        '云南省眼科医院': ('云南', '昆明'),
        '云南省耳鼻喉医院': ('云南', '昆明'),
        '云南省皮肤性病医院': ('云南', '昆明'),
        '云南省职业病医院': ('云南', '昆明'),
        '云南省传染病医院': ('云南', '昆明'),
        '云南省艾滋病关爱中心': ('云南', '昆明'),
        '云南省心理卫生中心': ('云南', '昆明'),
        '贵州省人民医院': ('贵州', '贵阳'),
        '贵州省第二人民医院': ('贵州', '贵阳'),
        '贵州省肿瘤医院': ('贵州', '贵阳'),
        '贵州省妇幼保健院': ('贵州', '贵阳'),
        '贵州省儿童医院': ('贵州', '贵阳'),
        '贵州省胸科医院': ('贵州', '贵阳'),
        '贵州省结核病医院': ('贵州', '贵阳'),
        '贵州省心血管病医院': ('贵州', '贵阳'),
        '贵州省神经病医院': ('贵州', '贵阳'),
        '贵州省骨科医院': ('贵州', '贵阳'),
        '贵州省烧伤医院': ('贵州', '贵阳'),
        '贵州省整形医院': ('贵州', '贵阳'),
        '贵州省眼科医院': ('贵州', '贵阳'),
        '贵州省耳鼻喉医院': ('贵州', '贵阳'),
        '贵州省皮肤性病医院': ('贵州', '贵阳'),
        '贵州省职业病医院': ('贵州', '贵阳'),
        '贵州省传染病医院': ('贵州', '贵阳'),
        '贵州省艾滋病关爱中心': ('贵州', '贵阳'),
        '贵州省心理卫生中心': ('贵州', '贵阳'),
        '四川省人民医院': ('四川', '成都'),
        '四川省肿瘤医院': ('四川', '成都'),
        '四川省妇幼保健院': ('四川', '成都'),
        '四川省儿童医院': ('四川', '成都'),
        '四川省胸科医院': ('四川', '成都'),
        '四川省结核病医院': ('四川', '成都'),
        '四川省心血管病医院': ('四川', '成都'),
        '四川省神经病医院': ('四川', '成都'),
        '四川省骨科医院': ('四川', '成都'),
        '四川省烧伤医院': ('四川', '成都'),
        '四川省整形医院': ('四川', '成都'),
        '四川省眼科医院': ('四川', '成都'),
        '四川省耳鼻喉医院': ('四川', '成都'),
        '四川省皮肤性病医院': ('四川', '成都'),
        '四川省职业病医院': ('四川', '成都'),
        '四川省传染病医院': ('四川', '成都'),
        '四川省艾滋病关爱中心': ('四川', '成都'),
        '四川省心理卫生中心': ('四川', '成都'),
        '西藏自治区人民医院': ('西藏', '拉萨'),
        '西藏自治区第二人民医院': ('西藏', '拉萨'),
        '西藏自治区第三人民医院': ('西藏', '拉萨'),
        '西藏自治区妇幼保健院': ('西藏', '拉萨'),
        '西藏自治区儿童医院': ('西藏', '拉萨'),
        '西藏自治区胸科医院': ('西藏', '拉萨'),
        '西藏自治区结核病医院': ('西藏', '拉萨'),
        '西藏自治区心血管病医院': ('西藏', '拉萨'),
        '西藏自治区神经病医院': ('西藏', '拉萨'),
        '西藏自治区骨科医院': ('西藏', '拉萨'),
        '西藏自治区烧伤医院': ('西藏', '拉萨'),
        '西藏自治区整形医院': ('西藏', '拉萨'),
        '西藏自治区眼科医院': ('西藏', '拉萨'),
        '西藏自治区耳鼻喉医院': ('西藏', '拉萨'),
        '西藏自治区皮肤性病医院': ('西藏', '拉萨'),
        '西藏自治区职业病医院': ('西藏', '拉萨'),
        '西藏自治区传染病医院': ('西藏', '拉萨'),
        '西藏自治区艾滋病关爱中心': ('西藏', '拉萨'),
        '西藏自治区心理卫生中心': ('西藏', '拉萨'),
        '重庆市人民医院': ('重庆', '重庆'),
        '重庆市第一人民医院': ('重庆', '重庆'),
        '重庆市第二人民医院': ('重庆', '重庆'),
        '重庆市第三人民医院': ('重庆', '重庆'),
        '重庆市第四人民医院': ('重庆', '重庆'),
        '重庆市第五人民医院': ('重庆', '重庆'),
        '重庆市第六人民医院': ('重庆', '重庆'),
        '重庆市第七人民医院': ('重庆', '重庆'),
        '重庆市第八人民医院': ('重庆', '重庆'),
        '重庆市第九人民医院': ('重庆', '重庆'),
        '重庆市第十人民医院': ('重庆', '重庆'),
        '重庆市妇幼保健院': ('重庆', '重庆'),
        '重庆市儿童医院': ('重庆', '重庆'),
        '重庆市胸科医院': ('重庆', '重庆'),
        '重庆市结核病医院': ('重庆', '重庆'),
        '重庆市心血管病医院': ('重庆', '重庆'),
        '重庆市神经病医院': ('重庆', '重庆'),
        '重庆市骨科医院': ('重庆', '重庆'),
        '重庆市烧伤医院': ('重庆', '重庆'),
        '重庆市整形医院': ('重庆', '重庆'),
        '重庆市眼科医院': ('重庆', '重庆'),
        '重庆市耳鼻喉医院': ('重庆', '重庆'),
        '重庆市皮肤性病医院': ('重庆', '重庆'),
        '重庆市职业病医院': ('重庆', '重庆'),
        '重庆市传染病医院': ('重庆', '重庆'),
        '重庆市艾滋病关爱中心': ('重庆', '重庆'),
        '重庆市心理卫生中心': ('重庆', '重庆'),
    }
    
    # 首先检查特殊医院映射
    if hospital_name in special_hospitals:
        return special_hospitals[hospital_name]
    
    # 根据医院名称推断省份和城市
    for province, cities in province_city_map.items():
        for city in cities:
            if city in hospital_name:
                return province, city
    
    # 如果没有找到具体城市，尝试根据省份关键词推断
    for province in province_city_map.keys():
        if province in hospital_name:
            # 返回省份和空城市
            return province, ""
    
    return "", ""

def supplement_csv_file(filename):
    """
    补充CSV文件中缺失的医院地理位置信息
    """
    print(f"正在补充文件: {filename}")
    
    # 读取CSV文件
    df = pd.read_csv(filename, encoding='utf-8-sig')
    
    # 统计补充前的信息
    before_province_count = len(df[df['省份'] != ''])
    before_city_count = len(df[df['城市'] != ''])
    
    print(f"补充前 - 有省份信息的记录数: {before_province_count}")
    print(f"补充前 - 有城市信息的记录数: {before_city_count}")
    
    # 为缺失信息的医院补充地理位置
    for index, row in df.iterrows():
        if row['省份'] == '' or row['城市'] == '':
            province, city = get_hospital_location_improved(row['医院名称'])
            
            if row['省份'] == '' and province != '':
                df.at[index, '省份'] = province
            if row['城市'] == '' and city != '':
                df.at[index, '城市'] = city
    
    # 统计补充后的信息
    after_province_count = len(df[df['省份'] != ''])
    after_city_count = len(df[df['城市'] != ''])
    
    print(f"补充后 - 有省份信息的记录数: {after_province_count}")
    print(f"补充后 - 有城市信息的记录数: {after_city_count}")
    print(f"新增省份信息: {after_province_count - before_province_count}")
    print(f"新增城市信息: {after_city_count - before_city_count}")
    
    # 保存更新后的文件
    df.to_csv(filename, index=False, encoding='utf-8-sig')
    print(f"文件已更新: {filename}\n")
    
    return df

def main():
    """
    主函数：补充所有CSV文件的地理位置信息
    """
    # 定义要处理的CSV文件列表
    csv_files = [
        "2023年度东北区专科声誉排行榜_with_info.csv",
        "2023年度华北区专科声誉排行榜_with_info.csv",
        "2023年度华东区专科声誉排行榜_with_info.csv",
        "2023年度华南区专科声誉排行榜_with_info.csv",
        "2023年度华中区专科声誉排行榜_with_info.csv",
        "2023年度西北区专科声誉排行榜_with_info.csv",
        "2023年度西南区专科声誉排行榜_with_info.csv"
    ]
    
    print("开始补充医院地理位置信息...")
    
    for csv_file in csv_files:
        if os.path.exists(csv_file):
            try:
                df = supplement_csv_file(csv_file)
            except Exception as e:
                print(f"处理 {csv_file} 时出错: {str(e)}\n")
        else:
            print(f"文件不存在: {csv_file}\n")
    
    print("所有文件地理位置信息补充完成！")

if __name__ == "__main__":
    main() 